<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Carpark Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-hover: #21262d;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-orange: #db6d28;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --border: #30363d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }
        
        header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        
        .meta { color: var(--text-secondary); font-size: 0.85rem; }
        .live-badge { 
            display: inline-block;
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .tab.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; }
        
        .summary-card.full .summary-value { color: var(--accent-red); }
        .summary-card.low .summary-value { color: var(--accent-orange); }
        .summary-card.ok .summary-value { color: var(--accent-green); }
        .summary-card.total .summary-value { color: var(--accent-blue); }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .panel-header h2 { font-size: 1rem; font-weight: 600; }
        
        .search-row { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .search-row input, .search-row select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
        }
        
        .search-row input { width: 200px; }
        .search-row input:focus, .search-row select:focus { outline: none; border-color: var(--accent-blue); }
        
        .refresh-btn {
            background: var(--accent-blue);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: #fff;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .refresh-btn:hover { opacity: 0.9; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .table-wrap { max-height: 600px; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-dark);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr { cursor: pointer; transition: background 0.15s; }
        tr:hover { background: var(--bg-hover); }
        tr.selected { background: rgba(88, 166, 255, 0.15); }
        
        .cp-name { font-weight: 500; }
        .cp-district { color: var(--text-secondary); font-size: 0.75rem; }
        
        .vacancy-num {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
        }
        
        .vacancy-num.full { color: var(--accent-red); }
        .vacancy-num.low { color: var(--accent-orange); }
        .vacancy-num.moderate { color: var(--accent-yellow); }
        .vacancy-num.ok { color: var(--accent-green); }
        .vacancy-num.capped { color: var(--accent-purple); }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge.full { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge.low { background: rgba(219, 109, 40, 0.2); color: var(--accent-orange); }
        .badge.moderate { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .badge.ok { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .badge.capped { background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }
        .badge.closed { background: rgba(125, 133, 144, 0.2); color: var(--text-secondary); }
        .vacancy-num.closed { color: var(--text-secondary); font-size: 0.9rem; }
        
        .detail-panel { position: sticky; top: 20px; }
        
        .detail-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .detail-header h3 { font-size: 1.1rem; margin-bottom: 5px; }
        .detail-header .district { color: var(--text-secondary); font-size: 0.85rem; }
        
        .detail-info {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); font-size: 0.8rem; flex-shrink: 0; }
        .info-value { color: var(--text-primary); font-size: 0.85rem; text-align: right; margin-left: 15px; }
        .info-divider { height: 1px; background: var(--accent-blue); margin: 10px 0; opacity: 0.3; }
        
        .chart-section { padding: 15px 20px; }
        .chart-title { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .chart-wrap { background: var(--bg-dark); border-radius: 8px; padding: 15px; height: 280px; }
        
        .no-selection { padding: 60px 20px; text-align: center; color: var(--text-secondary); }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .error { text-align: center; padding: 40px; color: var(--accent-red); }
        
        .name-zh { color: var(--text-secondary); font-size: 0.9rem; margin-top: 3px; }
        .status-line { margin-top: 10px; }
        
        /* Time interval selector */
        .time-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .time-btn {
            padding: 6px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .time-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .time-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
        
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .data-range-info {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó HK Carpark Monitor <span class="live-badge">‚óè LIVE</span></h1>
            <div class="meta">Real-time parking availability | Timezone: HKT (GMT+8)</div>
            <div class="meta" id="lastUpdate">Loading data from GitHub...</div>
            <div class="meta" style="margin-top:8px">
                <button class="refresh-btn" onclick="refreshData()" id="refreshBtn">‚ü≥ Refresh Now</button>
                <span style="margin-left:10px;font-size:0.75rem">Auto-refresh every 5 min</span>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="gov" id="tab-btn-gov">General Parking Data</button>
            <button class="tab" data-tab="wilson" id="tab-btn-wilson">Wilson Parking</button>
        </div>
        
        <!-- Government API Tab -->
        <div class="tab-content active" id="tab-gov">
            <div class="summary-grid" id="gov-summary"></div>
            <div class="main-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h2>All Carparks</h2>
                        <div class="search-row">
                            <input type="text" id="gov-search" placeholder="Search...">
                            <select id="gov-district"><option value="">All Districts</option></select>
                            <select id="gov-status">
                                <option value="">All Status</option>
                                <option value="FULL">Full</option>
                                <option value="LOW">Low</option>
                                <option value="MODERATE">Moderate</option>
                                <option value="OK">OK</option>
                                <option value="CLOSED">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Carpark</th>
                                    <th style="text-align:center">Available</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody id="gov-table"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel detail-panel" id="gov-detail">
                    <div class="no-selection">Select a carpark to view details</div>
                </div>
            </div>
        </div>
        
        <!-- Wilson Parking Tab -->
        <div class="tab-content" id="tab-wilson">
            <div class="summary-grid" id="wilson-summary"></div>
            <div class="main-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h2>All Carparks (Active Only)</h2>
                        <div class="search-row">
                            <input type="text" id="wilson-search" placeholder="Search...">
                            <select id="wilson-district"><option value="">All Districts</option></select>
                            <select id="wilson-status">
                                <option value="">All Status</option>
                                <option value="FULL">Full</option>
                                <option value="LOW">Low</option>
                                <option value="OK">10+ Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Carpark</th>
                                    <th>District</th>
                                    <th style="text-align:center">Available</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody id="wilson-table"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel detail-panel" id="wilson-detail">
                    <div class="no-selection">Select a carpark to view details</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const GITHUB_USER = 'Bryantsui';
        const GITHUB_REPO = 'wilson-parking-data';
        const GITHUB_BRANCH = 'main';
        const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;
        
        let govData = { carparks: {}, records: [], timeseries: {}, historicalData: {} };
        let wilsonData = { carparks: {}, records: [], timeseries: {}, historicalData: {} };
        let charts = { gov: null, wilson: null };
        let currentTimeRange = { gov: '1D', wilson: '1D' };
        let selectedCarpark = { gov: null, wilson: null };
        
        // Get dates for data fetching
        function getDateRange(days) {
            const dates = [];
            const now = new Date();
            for (let i = 0; i < days; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                // Convert to HKT
                const hkt = new Date(d.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
                dates.push(hkt.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function getTodayHKT() {
            const now = new Date();
            const hkt = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
            return hkt.toISOString().split('T')[0];
        }
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        
        async function fetchCSV(url) {
            const response = await fetch(url + '?t=' + Date.now());
            if (!response.ok) return null;
            const text = await response.text();
            return new Promise((resolve) => {
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: results => resolve(results.data),
                    error: () => resolve(null)
                });
            });
        }
        
        async function loadGovData() {
            const today = getTodayHKT();
            
            // Load carparks metadata
            const carparksData = await fetchCSV(`${RAW_BASE}/data/carparks.csv`);
            if (carparksData) {
                carparksData.forEach(cp => {
                    govData.carparks[cp.park_Id || cp.id] = cp;
                });
            }
            
            // Load today's vacancy data
            const vacancyData = await fetchCSV(`${RAW_BASE}/data/vacancy_${today}.csv`);
            if (!vacancyData) {
                document.getElementById('gov-table').innerHTML = '<tr><td colspan="4" class="error">No data for today yet</td></tr>';
                return;
            }
            govData.records = vacancyData;
            
            // Build timeseries and get latest
            const latest = {};
            govData.timeseries = {};
            
            vacancyData.forEach(record => {
                const id = record.park_id;
                const vacancy = parseInt(record.private_car_vacancy) || 0;
                const scraped = record.scraped_at;
                
                if (!govData.timeseries[id]) govData.timeseries[id] = [];
                govData.timeseries[id].push({
                    time: formatTime(scraped),
                    time_raw: scraped,
                    vacancy: vacancy,
                    is_capped: false
                });
                
                if (!latest[id] || scraped > latest[id].scraped_at) {
                    latest[id] = { ...record, scraped_at: scraped };
                }
            });
            
            // Store for historical loading
            govData.historicalData[today] = vacancyData;
            
            // Build current stats
            govData.current_stats = Object.entries(latest).map(([id, record]) => {
                const cp = govData.carparks[id] || {};
                const vacancy = parseInt(record.private_car_vacancy);
                const isClosed = vacancy === -1 || record.opening_status === 'CLOSED';
                const status = isClosed ? 'CLOSED' : vacancy === 0 ? 'FULL' : vacancy <= 10 ? 'LOW' : vacancy <= 30 ? 'MODERATE' : 'OK';
                
                return {
                    id,
                    name: cp.name || record.name || id,
                    district: cp.district || record.district || '',
                    vacancy: isClosed ? null : (isNaN(vacancy) ? null : vacancy),
                    vacancy_display: isClosed ? 'CLOSED' : vacancy,
                    status,
                    is_capped: false,
                    is_closed: isClosed,
                    last_update: formatTime(record.last_update || record.scraped_at)
                };
            }).sort((a, b) => {
                // Sort: open carparks first (by vacancy), then closed ones
                if (a.is_closed && !b.is_closed) return 1;
                if (!a.is_closed && b.is_closed) return -1;
                return (a.vacancy ?? 999) - (b.vacancy ?? 999);
            });
            
            // Calculate summary
            const stats = govData.current_stats;
            govData.summary = {
                total: stats.length,
                full: stats.filter(s => s.status === 'FULL').length,
                low: stats.filter(s => s.status === 'LOW').length,
                moderate: stats.filter(s => s.status === 'MODERATE').length,
                ok: stats.filter(s => s.status === 'OK').length,
                closed: stats.filter(s => s.status === 'CLOSED').length,
                records: govData.records.length
            };
        }
        
        async function loadWilsonData() {
            const today = getTodayHKT();
            
            // Load carparks metadata
            const carparksData = await fetchCSV(`${RAW_BASE}/data_wilson/carparks.csv`);
            if (carparksData) {
                carparksData.forEach(cp => {
                    wilsonData.carparks[cp.id] = cp;
                });
            }
            
            // Load today's availability data
            const availData = await fetchCSV(`${RAW_BASE}/data_wilson/availability_${today}.csv`);
            if (!availData) {
                document.getElementById('wilson-table').innerHTML = '<tr><td colspan="5" class="error">No data for today yet</td></tr>';
                return;
            }
            wilsonData.records = availData;
            
            // Build timeseries and get latest
            const latest = {};
            wilsonData.timeseries = {};
            
            availData.forEach(record => {
                const id = record.carpark_id;
                const vacancy = parseInt(record.guest_available) || 0;
                const scraped = record.scraped_at;
                const isCapped = record.guest_available_display === '10+';
                
                if (!wilsonData.timeseries[id]) wilsonData.timeseries[id] = [];
                wilsonData.timeseries[id].push({
                    time: formatTime(scraped),
                    time_raw: scraped,
                    vacancy: vacancy,
                    is_capped: isCapped
                });
                
                if (!latest[id] || scraped > latest[id].scraped_at) {
                    latest[id] = { ...record, scraped_at: scraped };
                }
            });
            
            // Store for historical loading
            wilsonData.historicalData[today] = availData;
            
            // Build current stats
            wilsonData.current_stats = Object.entries(latest)
                .filter(([id, record]) => {
                    const total = parseInt(record.total) || 0;
                    const guestTotal = parseInt(record.guest_total) || 0;
                    return total > 0 || guestTotal > 0;
                })
                .map(([id, record]) => {
                    const cp = wilsonData.carparks[id] || {};
                    const vacancy = parseInt(record.guest_available) || 0;
                    const isCapped = record.guest_available_display === '10+';
                    const status = vacancy === 0 ? 'FULL' : (!isCapped && vacancy < 10) ? 'LOW' : 'OK';
                    
                    return {
                        id,
                        name: cp.name_en || `Unknown (${id.slice(-8)})`,
                        code: cp.code || '',
                        district: cp.district || '',
                        region: cp.region || '',
                        address: cp.address_en || '',
                        vacancy,
                        vacancy_display: record.guest_available_display || String(vacancy),
                        guest_total: parseInt(record.guest_total) || 0,
                        monthly_available: parseInt(record.monthly_available) || 0,
                        monthly_total: parseInt(record.monthly_total) || 0,
                        monthly_is_full: record.monthly_is_full === 'True',
                        total_capacity: parseInt(record.total) || 0,
                        status,
                        is_capped: isCapped,
                        last_update: formatTime(record.scraped_at)
                    };
                }).sort((a, b) => a.name.localeCompare(b.name));
            
            // Calculate summary
            const stats = wilsonData.current_stats;
            wilsonData.summary = {
                total: stats.length,
                full: stats.filter(s => s.status === 'FULL').length,
                low: stats.filter(s => s.status === 'LOW').length,
                capped: stats.filter(s => s.is_capped).length,
                records: wilsonData.records.length
            };
        }
        
        // Load historical data for a specific date range
        async function loadHistoricalData(src, days) {
            const dates = getDateRange(days);
            const srcData = src === 'gov' ? govData : wilsonData;
            const folder = src === 'gov' ? 'data' : 'data_wilson';
            const filePrefix = src === 'gov' ? 'vacancy_' : 'availability_';
            
            for (const date of dates) {
                if (srcData.historicalData[date]) continue; // Already loaded
                
                const data = await fetchCSV(`${RAW_BASE}/${folder}/${filePrefix}${date}.csv`);
                if (data) {
                    srcData.historicalData[date] = data;
                }
            }
            
            return dates.filter(d => srcData.historicalData[d]);
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            try {
                const d = new Date(isoString);
                const hkt = new Date(d.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
                return `${String(hkt.getMonth()+1).padStart(2,'0')}-${String(hkt.getDate()).padStart(2,'0')} ${String(hkt.getHours()).padStart(2,'0')}:${String(hkt.getMinutes()).padStart(2,'0')}`;
            } catch {
                return isoString;
            }
        }
        
        function formatTimeShort(isoString, range) {
            if (!isoString) return '-';
            try {
                const d = new Date(isoString);
                const hkt = new Date(d.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
                
                if (range === '1D') {
                    return `${String(hkt.getHours()).padStart(2,'0')}:${String(hkt.getMinutes()).padStart(2,'0')}`;
                } else if (range === '1W') {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    return `${days[hkt.getDay()]} ${String(hkt.getHours()).padStart(2,'0')}:00`;
                } else {
                    return `${String(hkt.getMonth()+1).padStart(2,'0')}/${String(hkt.getDate()).padStart(2,'0')}`;
                }
            } catch {
                return isoString;
            }
        }
        
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                await Promise.all([loadGovData(), loadWilsonData()]);
                render();
                document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleString('en-HK', { timeZone: 'Asia/Hong_Kong' })} HKT`;
            } catch (e) {
                console.error(e);
                document.getElementById('lastUpdate').textContent = `Error: ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ü≥ Refresh Now';
            }
        }
        
        function render() {
            // Update tab counts
            document.getElementById('tab-btn-gov').textContent = `General Parking Data (${govData.current_stats?.length || 0})`;
            document.getElementById('tab-btn-wilson').textContent = `Wilson Parking (${wilsonData.current_stats?.length || 0})`;
            
            // Government
            if (govData.summary) {
                renderSummary('gov', govData.summary);
                renderTable('gov', govData.current_stats, govData.timeseries);
                populateDistricts('gov', govData.current_stats);
            }
            
            // Wilson
            if (wilsonData.summary) {
                renderSummary('wilson', wilsonData.summary);
                renderTable('wilson', wilsonData.current_stats, wilsonData.timeseries);
                populateDistricts('wilson', wilsonData.current_stats);
            }
            
            // Filters
            ['gov', 'wilson'].forEach(src => {
                const searchEl = document.getElementById(src + '-search');
                const statusEl = document.getElementById(src + '-status');
                const districtEl = document.getElementById(src + '-district');
                
                if (searchEl) searchEl.oninput = () => filterTable(src);
                if (statusEl) statusEl.onchange = () => filterTable(src);
                if (districtEl) districtEl.onchange = () => filterTable(src);
            });
        }
        
        function renderSummary(src, summary) {
            const container = document.getElementById(src + '-summary');
            if (!container) return;
            const isCapped = src === 'wilson';
            
            container.innerHTML = `
                <div class="summary-card total"><div class="summary-value">${summary.total}</div><div class="summary-label">Total Carparks</div></div>
                <div class="summary-card full"><div class="summary-value">${summary.full}</div><div class="summary-label">Full (0)</div></div>
                <div class="summary-card low"><div class="summary-value">${summary.low || 0}</div><div class="summary-label">Low (1-${isCapped ? '9' : '10'})</div></div>
                ${isCapped ? `<div class="summary-card ok"><div class="summary-value">${summary.capped || 0}</div><div class="summary-label">10+ Available</div></div>` : 
                `<div class="summary-card ok"><div class="summary-value">${summary.ok || 0}</div><div class="summary-label">OK (30+)</div></div>`}
                <div class="summary-card"><div class="summary-value">${summary.records}</div><div class="summary-label">Data Points Today</div></div>
            `;
        }
        
        function populateDistricts(src, stats) {
            if (!stats) return;
            const districts = [...new Set(stats.map(s => s.district).filter(d => d))].sort();
            const select = document.getElementById(src + '-district');
            if (select) {
                select.innerHTML = '<option value="">All Districts</option>';
                districts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d; opt.textContent = d;
                    select.appendChild(opt);
                });
            }
        }
        
        function renderTable(src, stats, timeseries) {
            const tbody = document.getElementById(src + '-table');
            if (!tbody || !stats) return;
            const isWilson = src === 'wilson';
            
            if (stats.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${isWilson ? 5 : 4}" class="no-selection">No carparks found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = stats.map(cp => {
                const vacancyClass = cp.is_closed ? 'closed' : cp.is_capped ? 'capped' : cp.status.toLowerCase();
                const vacancyDisplay = cp.vacancy_display ?? cp.vacancy ?? '-';
                const badge = cp.is_closed ? 'closed' : cp.is_capped ? 'capped' : cp.status.toLowerCase();
                const badgeText = cp.is_closed ? 'CLOSED' : cp.is_capped ? '10+' : cp.status;
                
                if (isWilson) {
                    return `
                        <tr data-id="${cp.id}" data-src="${src}">
                            <td>
                                <div class="cp-name">${cp.name}</div>
                                <div class="cp-district">${cp.code ? '(' + cp.code + ')' : ''}</div>
                            </td>
                            <td style="color:var(--text-secondary);font-size:0.85rem">${cp.district || '-'}</td>
                            <td><div class="vacancy-num ${vacancyClass}">${vacancyDisplay}</div></td>
                            <td><span class="badge ${badge}">${badgeText}</span></td>
                            <td style="color:var(--text-secondary);font-size:0.8rem">${cp.last_update || '-'}</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr data-id="${cp.id}" data-src="${src}">
                            <td>
                                <div class="cp-name">${cp.name}</div>
                                <div class="cp-district">${cp.district || ''}</div>
                            </td>
                            <td><div class="vacancy-num ${vacancyClass}">${vacancyDisplay}</div></td>
                            <td><span class="badge ${badge}">${badgeText}</span></td>
                            <td style="color:var(--text-secondary);font-size:0.8rem">${cp.last_update || '-'}</td>
                        </tr>
                    `;
                }
            }).join('');
            
            // Add click handlers
            tbody.querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('click', () => selectCarpark(tr.dataset.src, tr.dataset.id));
            });
        }
        
        function filterTable(src) {
            const search = document.getElementById(src + '-search')?.value?.toLowerCase() || '';
            const status = document.getElementById(src + '-status')?.value || '';
            const district = document.getElementById(src + '-district')?.value || '';
            
            const srcData = src === 'gov' ? govData : wilsonData;
            if (!srcData.current_stats) return;
            
            let filtered = srcData.current_stats;
            
            if (search) {
                filtered = filtered.filter(cp => 
                    cp.name.toLowerCase().includes(search) || 
                    (cp.district || '').toLowerCase().includes(search) ||
                    (cp.code || '').toLowerCase().includes(search)
                );
            }
            if (status) filtered = filtered.filter(cp => cp.status === status || (status === 'OK' && cp.is_capped));
            if (district) filtered = filtered.filter(cp => cp.district === district);
            
            renderTable(src, filtered, srcData.timeseries);
        }
        
        async function selectCarpark(src, id) {
            document.querySelectorAll(`tr[data-src="${src}"]`).forEach(tr => tr.classList.remove('selected'));
            document.querySelector(`tr[data-id="${id}"][data-src="${src}"]`)?.classList.add('selected');
            
            selectedCarpark[src] = id;
            const srcData = src === 'gov' ? govData : wilsonData;
            const cp = srcData.current_stats.find(c => c.id === id);
            if (!cp) return;
            
            const panel = document.getElementById(src + '-detail');
            const isWilson = src === 'wilson';
            const vacancyDisplay = isWilson ? (cp.vacancy_display || cp.vacancy) : cp.vacancy;
            
            let infoSection = '';
            if (isWilson) {
                const monthlyStatus = cp.monthly_is_full ? 
                    '<span style="color:var(--accent-red)">FULL</span>' : 
                    `<span style="color:var(--accent-green)">${cp.monthly_available} available</span>`;
                
                infoSection = `
                    <div class="detail-info">
                        <div class="info-row"><span class="info-label">Code</span><span class="info-value">${cp.code || '-'}</span></div>
                        <div class="info-row"><span class="info-label">District</span><span class="info-value">${cp.district || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Region</span><span class="info-value">${cp.region || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Address</span><span class="info-value">${cp.address || '-'}</span></div>
                        <div class="info-divider"></div>
                        <div class="info-row"><span class="info-label">Hourly Spaces</span><span class="info-value">${vacancyDisplay} / ${cp.guest_total || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Monthly Parking</span><span class="info-value">${monthlyStatus} (${cp.monthly_total || 0} total)</span></div>
                        <div class="info-row"><span class="info-label">Total Capacity</span><span class="info-value">${cp.total_capacity || '-'} spaces</span></div>
                        <div class="info-row"><span class="info-label">Last Update</span><span class="info-value">${cp.last_update || '-'}</span></div>
                    </div>
                `;
            } else {
                infoSection = `
                    <div class="detail-info">
                        <div class="info-row"><span class="info-label">District</span><span class="info-value">${cp.district || '-'}</span></div>
                        <div class="info-row"><span class="info-label">Available</span><span class="info-value" style="color:${getStatusColor(cp)}">${vacancyDisplay ?? '-'} spaces</span></div>
                        <div class="info-row"><span class="info-label">Last Update</span><span class="info-value">${cp.last_update || '-'}</span></div>
                    </div>
                `;
            }
            
            panel.innerHTML = `
                <div class="detail-header">
                    <h3>${cp.name}</h3>
                    <div class="status-line"><span class="badge ${cp.is_capped ? 'capped' : cp.status.toLowerCase()}">${cp.is_capped ? '10+' : cp.status}</span></div>
                </div>
                ${infoSection}
                <div class="chart-section">
                    <div class="chart-title">Availability Over Time</div>
                    <div class="time-selector">
                        <button class="time-btn ${currentTimeRange[src] === '1D' ? 'active' : ''}" onclick="changeTimeRange('${src}', '1D')">1D</button>
                        <button class="time-btn ${currentTimeRange[src] === '1W' ? 'active' : ''}" onclick="changeTimeRange('${src}', '1W')">1W</button>
                        <button class="time-btn ${currentTimeRange[src] === '1M' ? 'active' : ''}" onclick="changeTimeRange('${src}', '1M')">1M</button>
                        <button class="time-btn ${currentTimeRange[src] === 'ALL' ? 'active' : ''}" onclick="changeTimeRange('${src}', 'ALL')">ALL</button>
                    </div>
                    <div class="chart-wrap"><canvas id="${src}-chart"></canvas></div>
                    <div class="data-range-info" id="${src}-range-info"></div>
                </div>
            `;
            
            // Load chart with current time range
            await updateChart(src, id, currentTimeRange[src]);
        }
        
        async function changeTimeRange(src, range) {
            currentTimeRange[src] = range;
            
            // Update button states
            document.querySelectorAll(`#${src}-detail .time-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.textContent === range);
            });
            
            const id = selectedCarpark[src];
            if (id) {
                await updateChart(src, id, range);
            }
        }
        
        async function updateChart(src, id, range) {
            const chartWrap = document.querySelector(`#${src}-detail .chart-wrap`);
            const rangeInfo = document.getElementById(`${src}-range-info`);
            
            // Show loading
            chartWrap.innerHTML = '<div class="chart-loading">Loading historical data...</div>';
            
            // Determine days to fetch
            const daysMap = { '1D': 1, '1W': 7, '1M': 30, 'ALL': 60 };
            const days = daysMap[range] || 1;
            
            // Load historical data
            const loadedDates = await loadHistoricalData(src, days);
            
            // Rebuild timeseries from historical data
            const srcData = src === 'gov' ? govData : wilsonData;
            const allTimeseries = [];
            
            // Sort dates in chronological order
            loadedDates.sort();
            
            for (const date of loadedDates) {
                const dayData = srcData.historicalData[date];
                if (!dayData) continue;
                
                dayData.forEach(record => {
                    const recordId = src === 'gov' ? record.park_id : record.carpark_id;
                    if (recordId !== id) return;
                    
                    const vacancy = src === 'gov' 
                        ? parseInt(record.private_car_vacancy) || 0
                        : parseInt(record.guest_available) || 0;
                    const scraped = record.scraped_at;
                    const isCapped = src === 'wilson' && record.guest_available_display === '10+';
                    
                    allTimeseries.push({
                        time: formatTimeShort(scraped, range),
                        time_raw: scraped,
                        vacancy: vacancy,
                        is_capped: isCapped
                    });
                });
            }
            
            // Sort by timestamp
            allTimeseries.sort((a, b) => new Date(a.time_raw) - new Date(b.time_raw));
            
            // Downsample if too many points
            let displayData = allTimeseries;
            if (range === '1W' && allTimeseries.length > 168) {
                // ~168 points for 1 week at 30min intervals, downsample to hourly
                displayData = allTimeseries.filter((_, i) => i % 2 === 0);
            } else if (range === '1M' && allTimeseries.length > 720) {
                // Downsample to every 2 hours
                displayData = allTimeseries.filter((_, i) => i % 4 === 0);
            } else if (range === 'ALL' && allTimeseries.length > 500) {
                // Downsample to every 4 hours
                displayData = allTimeseries.filter((_, i) => i % 8 === 0);
            }
            
            // Update range info
            if (rangeInfo) {
                rangeInfo.textContent = `Showing ${displayData.length} data points from ${loadedDates.length} day(s)`;
            }
            
            // Recreate canvas
            chartWrap.innerHTML = `<canvas id="${src}-chart"></canvas>`;
            
            // Render chart
            renderChart(src, id, displayData, range);
        }
        
        function getStatusColor(cp) {
            if (cp.is_capped) return 'var(--accent-purple)';
            const colors = { FULL: 'var(--accent-red)', LOW: 'var(--accent-orange)', MODERATE: 'var(--accent-yellow)', OK: 'var(--accent-green)' };
            return colors[cp.status] || 'var(--text-primary)';
        }
        
        function renderChart(src, id, timeseries, range) {
            const ctx = document.getElementById(src + '-chart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts[src]) charts[src].destroy();
            
            const isCapped = timeseries.some(d => d.is_capped);
            
            charts[src] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeseries.map(d => d.time),
                    datasets: [{
                        label: 'Available Spaces',
                        data: timeseries.map(d => d.vacancy),
                        borderColor: isCapped ? '#a371f7' : '#3fb950',
                        backgroundColor: isCapped ? 'rgba(163,113,247,0.1)' : 'rgba(63,185,80,0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: range === '1D' ? 2 : 1,
                        pointBackgroundColor: timeseries.map(d => d.is_capped ? '#a371f7' : '#3fb950')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0].dataIndex;
                                    return formatTime(timeseries[idx].time_raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: '#30363d' }, 
                            ticks: { 
                                color: '#7d8590', 
                                maxTicksLimit: range === '1D' ? 12 : range === '1W' ? 7 : 10,
                                maxRotation: 45
                            } 
                        },
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#30363d' }, 
                            ticks: { color: '#7d8590' } 
                        }
                    }
                }
            });
        }
        
        // Initial load
        refreshData();
        
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>
